package helper_xendit

import (
	"fmt"

	domain_products "ppob/products/domain"
	domain_transaction "ppob/transaction/domain"
	domain_users "ppob/users/domain"

	"github.com/pborman/uuid"
	"github.com/xendit/xendit-go"
	"github.com/xendit/xendit-go/invoice"
)

func Xendit_Invoice(transaction domain_transaction.Detail_Transaction, product domain_products.Detail_Product, user domain_users.Users, cat string) (interface{}, error) {
	xendit.Opt.SecretKey = "xnd_development_I0guK5bOcQB3AVQ8pYUXMtXltsVvfqsyPU2dz1RJvTDNVrsLVxqC8K0KJc3YhlZE"
	code := uuid.New()

	customer := xendit.Customer{
		GivenNames:   user.Name,
		Email:        user.Email,
		MobileNumber: user.Phone,
	}

	invoiceCustomer := xendit.InvoiceCustomer{
		GivenNames:   customer.GivenNames,
		Email:        customer.Email,
		MobileNumber: customer.MobileNumber,
	}
	item := xendit.InvoiceItem{
		Name:     product.Name,
		Price:    float64(product.Price),
		Quantity: 1,
		Category: cat,
	}
	fee := xendit.InvoiceFee{
		Type:  "ADMIN",
		Value: float64(transaction.Fee),
	}

	NotificationType := []string{"whatsapp", "email", "sms"}
	customerNotificationPreference := xendit.InvoiceCustomerNotificationPreference{
		InvoiceCreated:  NotificationType,
		InvoiceReminder: NotificationType,
		InvoicePaid:     NotificationType,
		InvoiceExpired:  NotificationType,
	}

	data := invoice.CreateParams{
		ExternalID:                     "demo_" + code,
		Amount:                         item.Price + fee.Value,
		PayerEmail:                     "admin@bayeue.com",
		Description:                    "Paket Data XL",
		Items:                          []xendit.InvoiceItem{item},
		Customer:                       invoiceCustomer,
		Fees:                           []xendit.InvoiceFee{fee},
		CustomerNotificationPreference: customerNotificationPreference,
	}

	resp, err := invoice.Create(&data)
	if err != nil {
		return xendit.Invoice{}, err
	}
	fmt.Println("response ", resp)
	return resp, nil

}
